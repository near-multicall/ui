!function(){function e(e,t,a,n){Object.defineProperty(e,t,{get:a,set:n,enumerable:!0,configurable:!0})}function t(e){return e&&e.__esModule?e.default:e}var a=("undefined"!=typeof globalThis?globalThis:"undefined"!=typeof self?self:"undefined"!=typeof window?window:"undefined"!=typeof global?global:{}).parcelRequired5b2;a.register("52sUH",(function(t,n){var o;o=t.exports,Object.defineProperty(o,"__esModule",{value:!0,configurable:!0}),e(t.exports,"default",(function(){return l}));var l=a("1V0Jk").DaoPage})),a.register("1V0Jk",(function(n,o){e(n.exports,"DaoPage",(function(){return R}));var l=a("4jyMX"),s=a("6oBUX"),r=a("1ad3U"),i=a("daMGm"),d=a("lJitl"),c=a("6dJjI"),u=a("jzfTN"),f=a("3EJxI"),p=a("5kSJQ"),h=a("dKFh4"),m=a("lBpE3"),v=a("2K4Gt"),g=a("kA5ak"),x=a("lkyf4"),D=a("5NwFW"),b=a("44iF5"),A=a("5DZ9j"),j=a("6cds3"),y=a("dgThQ"),S=a("b58gW"),k=a("kWoHO"),_=a("lcSfn"),N=a("41glQ"),O=a("fkwEZ"),M=a("cfywZ"),I=a("dc0x8"),P=a("6qX7k"),T=a("hStsZ"),E=a("jpmSb"),w=a("gqEAf"),F=a("3vtly"),B=a("dEazb"),C=y.Wallet.trySelectorContext(),U="DaoPage",R=function(e){"use strict";(0,c.default)(n,e);var a=(0,p.default)(n);function n(e){var o;(0,r.default)(this,n),o=a.call(this,e),(0,d.default)((0,l.default)(o),"schema",k.args.object().shape({addr:k.args.object().shape({noAddress:k.args.string().address().retain({initial:!0}),noDao:k.args.string().sputnikDao().retain({initial:!0}),noMulticall:k.args.string().multicall().retain({customMessage:"DAO does not have a multicall instance",initial:!0})}).transform((function(e,t){return{noAddress:t,noDao:t,noMulticall:o.toMulticallAddress(t)}})).retain()}).retain()),(0,d.default)((0,l.default)(o),"tryLoadInfoDebounced",t(A)((function(){return o.tryLoadInfo()}),400)),(0,d.default)((0,l.default)(o),"fee","");var s=I.STORAGE.addresses.dao;return o.state={formData:{addr:s},dao:new(0,O.SputnikDAO)(s),multicall:new(0,N.Multicall)(o.toMulticallAddress(s)),loading:!1,proposed:-1,proposedInfo:null},o.schema.check(o.state.formData),N.Multicall.getFactoryFee().then((function(e){o.fee=e,o.tryLoadInfo()})),o.lastAddr=null,o}return(0,i.default)(n,[{key:"setFormData",value:function(e,t){this.setState({formData:(0,u.default)({},this.state.formData,e)},t)}},{key:"toMulticallAddress",value:function(e){return k.args.string().ensure().intoBaseAddress().append("."+N.Multicall.FACTORY_ADDRESS).cast(e)}},{key:"proposalAlreadyExists",value:function(e){return(0,s.default)((function(){var t,a,n,o,l,s;return(0,h.__generator)(this,(function(r){switch(r.label){case 0:return t=(0,M.Big)(Date.now()).times("1000000"),a=e.lastProposalId,n=e.policy.proposal_period,[4,e.getProposals({from_index:a<100?0:a-100,limit:100})];case 1:return o=r.sent(),(l=o.filter((function(e){var a,o,l,s,r,i;return(null===(a=e.kind)||void 0===a||null===(o=a.FunctionCall)||void 0===o?void 0:o.receiver_id)===N.Multicall.FACTORY_ADDRESS&&"create"===(null===(l=e.kind)||void 0===l||null===(s=l.FunctionCall)||void 0===s||null===(r=s.actions)||void 0===r||null===(i=r[0])||void 0===i?void 0:i.method_name)&&"InProgress"===e.status&&(0,M.Big)(e.submission_time).add(n).gt(t)}))).length>0?[2,{proposal_id:(s=l.pop()).id,proposal_info:s}]:[2,{proposal_id:-1,proposal_info:null}]}}))}))()}},{key:"onAddressesUpdated",value:function(e){var t;e.detail.dao!==this.state.formData.addr&&(this.setState({multicall:new(0,N.Multicall)(this.toMulticallAddress(e.detail.dao))}),null===(t=this.formikSetValues)||void 0===t||t.call(this,{addr:e.detail.dao}))}},{key:"createMulticall",value:function(){var e=this.context.accountId,t=this.state,a=t.loading,n=t.dao,o=t.proposed,l=t.proposedInfo,s=t.formData,r=(0,_.fields)(this.schema,"addr"),i=r.noMulticall,d=r.noDao;if(""===this.fee||!0!==(null==n?void 0:n.ready))return null;var c=this.toMulticallAddress(s.addr),u=(0,M.Big)(this.fee).plus(y.MI.MIN_BALANCE),f=document.querySelector(".DaoSearch input"),p=n.checkUserPermission(e,"AddProposal","FunctionCall"),h=n.checkUserPermission(e,"VoteApprove","FunctionCall"),v={proposal:{description:"create multicall instance for this DAO at ".concat(c),kind:{FunctionCall:{receiver_id:N.Multicall.FACTORY_ADDRESS,actions:[{method_name:"create",args:b.Base64.encode(JSON.stringify({multicall_init_args:{admin_accounts:[n.address],croncat_manager:window.nearConfig.CRONCAT_MANAGER_ADDRESS,job_bond:n.policy.proposal_bond},public_key:"HdJuXFRBKMEXuzEsXVscdd3aoBvEGGXDKQ3JoNhqJ4uU"})),deposit:u.toFixed(),gas:(0,M.toGas)("150")}]}}}};if(i.isBad()&&!d.isBad()&&!a&&this.lastAddr===f.value){if(-1===o)return p?(0,m.jsxs)(m.Fragment,{children:[(0,m.jsxs)("div",{className:"Alert",children:["A multicall instance can only be created for ",(0,m.jsx)("a",{href:n.getDaoUrl(O.SputnikUI.ASTRO_UI),target:"_blank",rel:"noopener noreferrer",children:n.address})," by making a proposal."]}),(0,m.jsx)("button",{className:"create-multicall",onClick:function(){n.addProposal(v).then((function(e){return(0,P.signAndSendTxs)([e])}))},children:"Propose"})]}):(0,m.jsx)("div",{className:"Alert",children:"This DAO has no multicall instance. A DAO member with proposing permissions should make a proposal."});if(-1!==o)return h?(null==l?void 0:l.votes[e])?(0,m.jsxs)("div",{className:"Alert",children:["You have voted on creating a multicall instance for this DAO. It will be created as soon as the proposal passes voting.",(0,m.jsx)("br",{}),(0,m.jsx)("a",{target:"_blank",href:n.getProposalUrl(O.SputnikUI.ASTRO_UI,o),rel:"noopener noreferrer",children:"Proposal on Astro"})]}):(0,m.jsxs)(m.Fragment,{children:[(0,m.jsxs)("div",{className:"Alert",children:["There exists a proposal (#".concat(o,") to create a multicall instance for this DAO. "),(0,m.jsx)("a",{href:n.getProposalUrl(O.SputnikUI.ASTRO_UI,o),target:"_blank",rel:"noopener noreferrer",children:"Open on AstroDAO"})]}),(0,m.jsx)("button",{className:"create-multicall proposal-exists",onClick:function(){n.actProposal(o,"VoteApprove").then((function(e){return(0,P.signAndSendTxs)([e])}))},children:"vote YES"})]}):(0,m.jsxs)("div",{className:"Alert",children:["Proposal to create a multicall exists (#".concat(o,"), but you have no voting permissions on this DAO."),(0,m.jsx)("br",{}),(0,m.jsx)("a",{target:"_blank",href:n.getProposalUrl(O.SputnikUI.ASTRO_UI,o),rel:"noopener noreferrer",children:"Proposal on Astro"})]})}}},{key:"toLink",value:function(e){var t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];return(0,m.jsxs)("span",{children:[(0,m.jsx)("a",{href:k.args.string().address().intoUrl().cast(e),target:"_blank",rel:"noopener noreferrer",children:e}),t?(0,m.jsx)(v.default,{}):null]})}},{key:"job",value:function(e){return(0,m.jsxs)("div",{className:"JobsList-item",children:[(0,m.jsx)(g.default,{}),(0,m.jsx)(v.default,{}),e.is_active?(0,m.jsx)(x.default,{}):(0,m.jsx)(D.default,{}),(0,m.jsx)("pre",{children:JSON.stringify(e,null,"  ")})]})}},{key:"tryLoadInfo",value:function(){var e=this;this.lastAddr!==this.state.formData.addr&&(this.lastAddr=this.state.formData.addr,this.schema.check(this.state.formData).then((function(){var t=(0,_.fields)(e.schema,"addr").noDao;e.schema.isBad()?t.isBad()?e.setState({proposed:-1,proposedInfo:null,dao:new(0,O.SputnikDAO)(e.state.formData.addr)}):e.confidentlyLoadOnlyDaoInfo():e.confidentlyLoadInfo()})))}},{key:"confidentlyLoadOnlyDaoInfo",value:function(){var e=this,t=this.state.formData.addr,a=this.toMulticallAddress(t);this.setState({loading:!0}),O.SputnikDAO.init(t).catch((function(e){return new(0,O.SputnikDAO)(t)})).then((function(t){var n,o;t.ready?e.proposalAlreadyExists(t).catch((function(e){})).then((function(l){return e.setState({dao:t,multicall:new(0,N.Multicall)(a),loading:!1,proposed:null!==(n=null==l?void 0:l.proposal_id)&&void 0!==n?n:-1,proposedInfo:null!==(o=null==l?void 0:l.proposal_info)&&void 0!==o?o:null})})):e.setState({dao:t,multicall:new(0,N.Multicall)(a),loading:!1})}))}},{key:"confidentlyLoadInfo",value:function(){var e=this,t=this.state.formData.addr,a=this.toMulticallAddress(t);this.setState({loading:!0}),Promise.all([O.SputnikDAO.init(t).catch((function(e){return new(0,O.SputnikDAO)(t)})),N.Multicall.init(a).catch((function(e){return new(0,N.Multicall)(a)}))]).then((function(t){var a,n,o=(0,f.default)(t,2),l=o[0],s=o[1];l.ready&&s.ready?e.proposalAlreadyExists(l).catch((function(e){})).then((function(t){return e.setState({dao:l,multicall:s,loading:!1,proposed:null!==(a=null==t?void 0:t.proposal_id)&&void 0!==a?a:-1,proposedInfo:null!==(n=null==t?void 0:t.proposal_info)&&void 0!==n?n:null})})):e.setState({dao:l,multicall:s,loading:!1})}))}},{key:"getContent",value:function(){var e=this.context.selector,t=this.state,a=t.dao,n=t.loading,o=t.multicall;if(!e.isSignedIn())return(0,m.jsx)("div",{className:"DaoPage-content error",children:"Please sign in to continue"});var l=["noAddress","noDao","noMulticall"],s=Object.entries((0,_.fields)(this.schema,"addr")).filter((function(e){var t=(0,f.default)(e,2),a=t[0];return t[1].isBad()&&l.includes(a)})).map((function(e){var t=(0,f.default)(e,2),a=t[0],n=t[1];return(0,m.jsxs)("p",{className:"red",children:[(0,m.jsxs)("span",{children:[n.isBad()?"✗":"✔"," "]}),n.message()]},"p-".concat(a))}));return s.length>0?(0,m.jsx)(m.Fragment,{children:(0,m.jsxs)("div",{className:"DaoPage-content error",children:[(0,m.jsx)("div",{children:s}),this.createMulticall()]})}):n?(0,m.jsx)("div",{className:"DaoPage-content loader"}):o.admins&&o.tokensWhitelist&&o.jobBond?(0,m.jsx)(T.Tabs,{classes:{root:"DaoPage-tabs",buttonsPanel:"DaoPage-tabs-buttonsPanel",contentSpace:"DaoPage-tabs-contentSpace"},items:[w.DaoSettingsTab.uiConnect({className:"".concat(U,"-content"),adapters:{dao:a,multicall:o}}),F.DaoFundsTab.uiConnect({className:"".concat(U,"-content"),adapters:{dao:a,multicall:o}}),B.DaoJobsTab.uiConnect({className:"".concat(U,"-content"),adapters:{multicall:o}})]}):(console.error("multicall infos incomplete",o),(0,m.jsx)("div",{className:"DaoPage-content error",children:"Unexpected error! Multicall might be outdated."}))}},{key:"componentDidMount",value:function(){var e=this;window.SIDEBAR.switchPage("dao"),document.addEventListener("onaddressesupdated",(function(t){return e.onAddressesUpdated(t)}))}},{key:"render",value:function(){var e,t=this;return(0,m.jsxs)("div",{className:"DaoPage",children:[(0,m.jsx)("div",{className:"DaoPage-header",children:(0,m.jsx)("div",{className:"DaoSearch",children:(0,m.jsx)(S.Formik,{initialValues:{addr:null!==(e=I.STORAGE.addresses.dao)&&void 0!==e?e:""},validate:function(e){t.setFormData({addr:e.addr}),t.tryLoadInfoDebounced()},onSubmit:function(){},children:function(e){var a=e.setValues;return t.formikSetValues=a,(0,m.jsx)(S.Form,{children:(0,m.jsx)(E.TextField,{name:"addr",placeholder:"Search for DAOs",hiddenLabel:!0,variant:"standard",autoFocus:!0})})}})})}),this.getContent()]})}}]),n}(j.Component);(0,d.default)(R,"contextType",C)})),a.register("lkyf4",(function(t,n){e(t.exports,"default",(function(){return s}));var o=a("1SOLG"),l=a("lBpE3"),s=(0,o.default)((0,l.jsx)("path",{d:"M6 19h4V5H6v14zm8-14v14h4V5h-4z"}),"PauseOutlined")})),a.register("5NwFW",(function(t,n){e(t.exports,"default",(function(){return s}));var o=a("1SOLG"),l=a("lBpE3"),s=(0,o.default)((0,l.jsx)("path",{d:"M10 8.64 15.27 12 10 15.36V8.64M8 5v14l11-7L8 5z"}),"PlayArrowOutlined")})),a.register("gqEAf",(function(t,n){e(t.exports,"DaoSettingsTab",(function(){return u}));var o=a("jzfTN"),l=a("hy8Go"),s=a("1OpYf"),r=a("lBpE3"),i=a("b8Wwb"),d=a("b3WIu"),c=function(e){var t=e.className,a=e.adapters,n=(0,s.default)(e,["className","adapters"]);return(0,r.jsx)("div",(0,l.default)((0,o.default)({className:(0,i.default)("DaoSettingsTab",t)},n),{children:(0,r.jsx)(d.SettingsEditor.UI,{adapters:a})}))},u={uiConnect:function(e){return{content:(0,r.jsx)(c,(0,o.default)({},e)),name:"Settings"}}}})),a.register("3vtly",(function(t,n){e(t.exports,"DaoFundsTab",(function(){return u}));var o=a("jzfTN"),l=a("hy8Go"),s=a("1OpYf"),r=a("lBpE3"),i=a("b8Wwb"),d=a("b3WIu"),c=function(e){var t=e.className,a=e.adapters,n=(0,s.default)(e,["className","adapters"]);return(0,r.jsx)("div",(0,l.default)((0,o.default)({className:(0,i.default)("DaoFundsTab",t)},n),{children:(0,r.jsx)(d.TokenBalances.UI,{adapters:a})}))},u={uiConnect:function(e){return{content:(0,r.jsx)(c,(0,o.default)({},e)),lazy:!0,name:"Funds"}}}})),a.register("dEazb",(function(t,n){e(t.exports,"DaoJobsTab",(function(){return u}));var o=a("jzfTN"),l=a("hy8Go"),s=a("1OpYf"),r=a("lBpE3"),i=a("b8Wwb"),d=a("dgThQ"),c=function(e){var t=e.className,a=e.adapters,n=(0,s.default)(e,["className","adapters"]);return(0,r.jsx)("div",(0,l.default)((0,o.default)({className:(0,i.default)("DaoJobsTab",t)},n),{children:(0,r.jsx)(d.Job.EntriesTable,{adapters:a})}))},u={uiConnect:function(e){return{content:(0,r.jsx)(c,(0,o.default)({},e)),lazy:!0,name:"Jobs"}}}}))}();
//# sourceMappingURL=dao.b0ee166a.js.map
