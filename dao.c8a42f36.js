function e(e,t,a,s){Object.defineProperty(e,t,{get:a,set:s,enumerable:!0,configurable:!0})}var t=("undefined"!=typeof globalThis?globalThis:"undefined"!=typeof self?self:"undefined"!=typeof window?window:"undefined"!=typeof global?global:{}).parcelRequired5b2,a=t.register;a("lVajM",function(a,s){Object.defineProperty(a.exports,"__esModule",{value:!0,configurable:!0}),e(a.exports,"default",function(){return l});var l=t("lVN1e").DaoPage}),a("lVN1e",function(a,s){e(a.exports,"DaoPage",function(){return P});var l=t("bbzbN"),n=t("eGhT9"),o=t("v5kPS"),i=t("66p6C"),r=t("hRwrB"),d=t("aU4vn"),c=t("bbKUP"),u=t("7fPBF"),h=t("gHnkO"),p=t("1ZNeQ"),m=t("1uHj9"),f=t("6BOtK"),g=t("7QLvx"),b=t("gtsNQ"),v=t("7ke7j"),x=t("uY0A8"),D=t("k4Ope"),A=t("jTKS4"),j=t("6i49h"),S=t("j7gVq"),O=t("cZYma"),y=t("4QTOn");let N=(0,h.Wallet).trySelectorContext(),_="DaoPage";class P extends u.Component{setFormData(e,t){this.setState({formData:{...this.state.formData,...e}},t)}toMulticallAddress(e){return(0,m.args).string().ensure().intoBaseAddress().append("."+g.Multicall.FACTORY_ADDRESS).cast(e)}async proposalAlreadyExists(e){let t=(0,v.Big)(Date.now()).times("1000000"),a=e.lastProposalId,s=e.policy.proposal_period,l=(await e.getProposals({from_index:a<100?0:a-100,limit:100})).filter(e=>{var a,l,n,o,i,r;return(null===(l=e.kind)||void 0===l?void 0:null===(a=l.FunctionCall)||void 0===a?void 0:a.receiver_id)===g.Multicall.FACTORY_ADDRESS&&(null===(r=e.kind)||void 0===r?void 0:null===(i=r.FunctionCall)||void 0===i?void 0:null===(o=i.actions)||void 0===o?void 0:null===(n=o[0])||void 0===n?void 0:n.method_name)==="create"&&"InProgress"===e.status&&(0,v.Big)(e.submission_time).add(s).gt(t)});if(!(l.length>0))return{proposal_id:-1,proposal_info:null};{let e=l.pop();return{proposal_id:e.id,proposal_info:e}}}onAddressesUpdated(e){if(e.detail.dao!==this.state.formData.addr){var t;this.setState({multicall:new g.Multicall(this.toMulticallAddress(e.detail.dao))}),null===(t=this.formikSetValues)||void 0===t||t.call(this,{addr:e.detail.dao})}}createMulticall(){let{accountId:e}=this.context,{loading:t,dao:a,proposed:s,proposedInfo:n,formData:o}=this.state,{noMulticall:i,noDao:r}=(0,f.fields)(this.schema,"addr");if(""===this.fee||(null==a?void 0:a.ready)!==!0)return null;let c=this.toMulticallAddress(o.addr),u=(0,v.Big)(this.fee).plus(h.MI.MIN_BALANCE),p=document.querySelector(".DaoSearch input"),m=a.checkUserPermission(e,"AddProposal","FunctionCall"),x=a.checkUserPermission(e,"VoteApprove","FunctionCall"),A={proposal:{description:`create multicall instance for this DAO at ${c}`,kind:{FunctionCall:{receiver_id:g.Multicall.FACTORY_ADDRESS,actions:[{method_name:"create",args:(0,d.Base64).encode(JSON.stringify({multicall_init_args:{admin_accounts:[a.address],croncat_manager:window.nearConfig.CRONCAT_MANAGER_ADDRESS,job_bond:a.policy.proposal_bond},public_key:"HdJuXFRBKMEXuzEsXVscdd3aoBvEGGXDKQ3JoNhqJ4uU"})),deposit:u.toFixed(),gas:(0,v.toGas)("150")}]}}}};if(i.isBad()&&!r.isBad()&&!t&&this.lastAddr===p.value){if(-1===s)return m?(0,l.jsxs)(l.Fragment,{children:[(0,l.jsxs)("div",{className:"Alert",children:["A multicall instance can only be created for ",(0,l.jsx)("a",{href:a.getDaoUrl(b.SputnikUI.ASTRO_UI),target:"_blank",rel:"noopener noreferrer",children:a.address})," by making a proposal."]}),(0,l.jsx)("button",{className:"create-multicall",onClick:()=>{a.addProposal(A).then(e=>(0,D.signAndSendTxs)([e]))},children:"Propose"})]}):(0,l.jsx)("div",{className:"Alert",children:"This DAO has no multicall instance. A DAO member with proposing permissions should make a proposal."});if(-1!==s)return x?(null==n?void 0:n.votes[e])?(0,l.jsxs)("div",{className:"Alert",children:["You have voted on creating a multicall instance for this DAO. It will be created as soon as the proposal passes voting.",(0,l.jsx)("br",{}),(0,l.jsx)("a",{target:"_blank",href:a.getProposalUrl(b.SputnikUI.ASTRO_UI,s),rel:"noopener noreferrer",children:"Proposal on Astro"})]}):(0,l.jsxs)(l.Fragment,{children:[(0,l.jsxs)("div",{className:"Alert",children:[`There exists a proposal (#${s}) to create a multicall instance for this DAO. `,(0,l.jsx)("a",{href:a.getProposalUrl(b.SputnikUI.ASTRO_UI,s),target:"_blank",rel:"noopener noreferrer",children:"Open on AstroDAO"})]}),(0,l.jsx)("button",{className:"create-multicall proposal-exists",onClick:()=>{a.actProposal(s,"VoteApprove").then(e=>(0,D.signAndSendTxs)([e]))},children:"vote YES"})]}):(0,l.jsxs)("div",{className:"Alert",children:[`Proposal to create a multicall exists (#${s}), but you have no voting permissions on this DAO.`,(0,l.jsx)("br",{}),(0,l.jsx)("a",{target:"_blank",href:a.getProposalUrl(b.SputnikUI.ASTRO_UI,s),rel:"noopener noreferrer",children:"Proposal on Astro"})]})}}toLink(e,t=!0){return(0,l.jsxs)("span",{children:[(0,l.jsx)("a",{href:(0,m.args).string().address().intoUrl().cast(e),target:"_blank",rel:"noopener noreferrer",children:e}),t?(0,l.jsx)(n.default,{}):null]})}job(e){return(0,l.jsxs)("div",{className:"JobsList-item",children:[(0,l.jsx)(o.default,{}),(0,l.jsx)(n.default,{}),e.is_active?(0,l.jsx)(i.default,{}):(0,l.jsx)(r.default,{}),(0,l.jsx)("pre",{children:JSON.stringify(e,null,"  ")})]})}tryLoadInfo(){this.lastAddr!==this.state.formData.addr&&(this.lastAddr=this.state.formData.addr,this.schema.check(this.state.formData).then(()=>{let{noDao:e}=(0,f.fields)(this.schema,"addr");this.schema.isBad()?e.isBad()?this.setState({proposed:-1,proposedInfo:null,dao:new b.SputnikDAO(this.state.formData.addr)}):this.confidentlyLoadOnlyDaoInfo():this.confidentlyLoadInfo()}))}confidentlyLoadOnlyDaoInfo(){let{addr:e}=this.state.formData,t=this.toMulticallAddress(e);this.setState({loading:!0}),(0,b.SputnikDAO).init(e).catch(t=>new b.SputnikDAO(e)).then(e=>{if(e.ready)this.proposalAlreadyExists(e).catch(e=>{}).then(a=>{var s,l;return this.setState({dao:e,multicall:new g.Multicall(t),loading:!1,proposed:null!==(s=null==a?void 0:a.proposal_id)&&void 0!==s?s:-1,proposedInfo:null!==(l=null==a?void 0:a.proposal_info)&&void 0!==l?l:null})});else{this.setState({dao:e,multicall:new g.Multicall(t),loading:!1});return}})}confidentlyLoadInfo(){let{addr:e}=this.state.formData,t=this.toMulticallAddress(e);this.setState({loading:!0}),Promise.all([(0,b.SputnikDAO).init(e).catch(t=>new b.SputnikDAO(e)),(0,g.Multicall).init(t).catch(e=>new g.Multicall(t))]).then(([e,t])=>{e.ready&&t.ready?this.proposalAlreadyExists(e).catch(e=>{}).then(a=>{var s,l;return this.setState({dao:e,multicall:t,loading:!1,proposed:null!==(s=null==a?void 0:a.proposal_id)&&void 0!==s?s:-1,proposedInfo:null!==(l=null==a?void 0:a.proposal_info)&&void 0!==l?l:null})}):this.setState({dao:e,multicall:t,loading:!1})})}getContent(){let{selector:e}=this.context,{dao:t,loading:a,multicall:s}=this.state;if(!e.isSignedIn())return(0,l.jsx)("div",{className:"DaoPage-content error",children:"Please sign in to continue"});let n=["noAddress","noDao","noMulticall"],o=Object.entries((0,f.fields)(this.schema,"addr")).filter(([e,t])=>t.isBad()&&n.includes(e)).map(([e,t])=>(0,l.jsxs)("p",{className:"red",children:[(0,l.jsxs)("span",{children:[t.isBad()?"✗":"✔"," "]}),t.message()]},`p-${e}`));return o.length>0?(0,l.jsx)(l.Fragment,{children:(0,l.jsxs)("div",{className:"DaoPage-content error",children:[(0,l.jsx)("div",{children:o}),this.createMulticall()]})}):a?(0,l.jsx)("div",{className:"DaoPage-content loader"}):s.admins&&s.tokensWhitelist&&s.jobBond?(0,l.jsx)(A.Tabs,{classes:{root:"DaoPage-tabs",buttonsPanel:"DaoPage-tabs-buttonsPanel",contentSpace:"DaoPage-tabs-contentSpace"},items:[(0,S.DaoSettingsTab).uiConnect({className:`${_}-content`,adapters:{dao:t,multicall:s}}),(0,O.DaoFundsTab).uiConnect({className:`${_}-content`,adapters:{dao:t,multicall:s}}),(0,y.DaoJobsTab).uiConnect({className:`${_}-content`,multicallInstance:s})]}):(console.error("multicall infos incomplete",s),(0,l.jsx)("div",{className:"DaoPage-content error",children:"Unexpected error! Multicall might be outdated."}))}componentDidMount(){window.SIDEBAR.switchPage("dao"),document.addEventListener("onaddressesupdated",e=>this.onAddressesUpdated(e))}render(){var e;return(0,l.jsxs)("div",{className:"DaoPage",children:[(0,l.jsx)("div",{className:"DaoPage-header",children:(0,l.jsx)("div",{className:"DaoSearch",children:(0,l.jsx)(p.Formik,{initialValues:{addr:null!==(e=x.STORAGE.addresses.dao)&&void 0!==e?e:""},validate:e=>{this.setFormData({addr:e.addr}),this.tryLoadInfoDebounced()},onSubmit:()=>{},children:({setValues:e})=>(this.formikSetValues=e,(0,l.jsx)(p.Form,{children:(0,l.jsx)(j.TextField,{name:"addr",placeholder:"Search for DAOs",hiddenLabel:!0,variant:"standard",autoFocus:!0})}))})})}),this.getContent()]})}constructor(e){super(e),this.schema=(0,m.args).object().shape({addr:(0,m.args).object().shape({noAddress:(0,m.args).string().address().retain({initial:!0}),noDao:(0,m.args).string().sputnikDao().retain({initial:!0}),noMulticall:(0,m.args).string().multicall().retain({customMessage:"DAO does not have a multicall instance",initial:!0})}).transform((e,t)=>({noAddress:t,noDao:t,noMulticall:this.toMulticallAddress(t)})).retain()}).retain(),this.tryLoadInfoDebounced=(c&&c.__esModule?c.default:c)(()=>this.tryLoadInfo(),400),this.fee="";let t=x.STORAGE.addresses.dao;this.state={formData:{addr:t},dao:new b.SputnikDAO(t),multicall:new g.Multicall(this.toMulticallAddress(t)),loading:!1,proposed:-1,proposedInfo:null},this.schema.check(this.state.formData),(0,g.Multicall).getFactoryFee().then(e=>{this.fee=e,this.tryLoadInfo()}),this.lastAddr=null}}P.contextType=N}),a("66p6C",function(a,s){e(a.exports,"default",function(){return o});var l=t("6PKLM"),n=t("bbzbN"),o=(0,l.default)((0,n.jsx)("path",{d:"M6 19h4V5H6v14zm8-14v14h4V5h-4z"}),"PauseOutlined")}),a("hRwrB",function(a,s){e(a.exports,"default",function(){return o});var l=t("6PKLM"),n=t("bbzbN"),o=(0,l.default)((0,n.jsx)("path",{d:"M10 8.64 15.27 12 10 15.36V8.64M8 5v14l11-7L8 5z"}),"PlayArrowOutlined")}),a("j7gVq",function(a,s){e(a.exports,"DaoSettingsTab",function(){return r});var l=t("bbzbN"),n=t("jtRae"),o=t("4ys6O");let i=({className:e,adapters:t,...a})=>(0,l.jsx)("div",{className:(0,n.default)("DaoSettingsTab",e),...a,children:(0,l.jsx)(o.SettingsEditor.UI,{adapters:t})}),r={uiConnect:e=>({content:(0,l.jsx)(i,{...e}),name:"Settings"})}}),a("cZYma",function(a,s){e(a.exports,"DaoFundsTab",function(){return r});var l=t("bbzbN"),n=t("jtRae"),o=t("4ys6O");let i=({className:e,adapters:t,...a})=>(0,l.jsx)("div",{className:(0,n.default)("DaoFundsTab",e),...a,children:(0,l.jsx)(o.TokenBalances.UI,{adapters:t})}),r={uiConnect:e=>({content:(0,l.jsx)(i,{...e}),lazy:!0,name:"Funds"})}}),a("4QTOn",function(a,s){e(a.exports,"DaoJobsTab",function(){return r});var l=t("bbzbN"),n=t("jtRae"),o=t("gHnkO");let i=({className:e,multicallInstance:t,...a})=>(0,l.jsx)("div",{className:(0,n.default)("DaoJobsTab",e),...a,children:(0,l.jsx)(o.Job.EntriesTable,{multicallInstance:t})}),r={uiConnect:e=>({content:(0,l.jsx)(i,{...e}),lazy:!0,name:"Jobs"})}});
//# sourceMappingURL=dao.c8a42f36.js.map
