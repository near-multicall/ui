function e(e,t,a,s){Object.defineProperty(e,t,{get:a,set:s,enumerable:!0,configurable:!0})}function t(e){return e&&e.__esModule?e.default:e}var a=("undefined"!=typeof globalThis?globalThis:"undefined"!=typeof self?self:"undefined"!=typeof window?window:"undefined"!=typeof global?global:{}).parcelRequired5b2;a.register("lVajM",(function(t,s){var n;n=t.exports,Object.defineProperty(n,"__esModule",{value:!0,configurable:!0}),e(t.exports,"default",(function(){return o}));var o=a("lVN1e").DaoPage})),a.register("lVN1e",(function(s,n){e(s.exports,"DaoPage",(function(){return M}));var o=a("kE6vJ"),l=a("bbzbN"),i=a("eGhT9"),r=a("v5kPS"),d=a("66p6C"),c=a("hRwrB"),u=a("aU4vn"),h=a("bbKUP"),p=a("7fPBF"),f=a("gHnkO"),m=a("1ZNeQ"),g=a("1uHj9"),b=a("6BOtK"),v=a("7QLvx"),x=a("gtsNQ"),D=a("7ke7j"),A=a("uY0A8"),j=a("k4Ope"),S=a("jTKS4"),O=a("6i49h"),y=a("j7gVq"),N=a("cZYma"),_=a("4QTOn");const P=f.Wallet.trySelectorContext(),k="DaoPage";class M extends p.Component{setFormData(e,t){this.setState({formData:{...this.state.formData,...e}},t)}toMulticallAddress(e){return g.args.string().ensure().intoBaseAddress().append("."+v.Multicall.FACTORY_ADDRESS).cast(e)}async proposalAlreadyExists(e){const t=(0,D.Big)(Date.now()).times("1000000"),a=e.lastProposalId,s=e.policy.proposal_period,n=(await e.getProposals({from_index:a<100?0:a-100,limit:100})).filter((e=>{var a,n,o,l,i,r;return(null===(a=e.kind)||void 0===a||null===(n=a.FunctionCall)||void 0===n?void 0:n.receiver_id)===v.Multicall.FACTORY_ADDRESS&&"create"===(null===(o=e.kind)||void 0===o||null===(l=o.FunctionCall)||void 0===l||null===(i=l.actions)||void 0===i||null===(r=i[0])||void 0===r?void 0:r.method_name)&&"InProgress"===e.status&&(0,D.Big)(e.submission_time).add(s).gt(t)}));if(n.length>0){const e=n.pop();return{proposal_id:e.id,proposal_info:e}}return{proposal_id:-1,proposal_info:null}}onAddressesUpdated(e){var t;e.detail.dao!==this.state.formData.addr&&(this.setState({multicall:new(0,v.Multicall)(this.toMulticallAddress(e.detail.dao))}),null===(t=this.formikSetValues)||void 0===t||t.call(this,{addr:e.detail.dao}))}createMulticall(){const{accountId:e}=this.context,{loading:t,dao:a,proposed:s,proposedInfo:n,formData:o}=this.state,{noMulticall:i,noDao:r}=(0,b.fields)(this.schema,"addr");if(""===this.fee||!0!==(null==a?void 0:a.ready))return null;const d=this.toMulticallAddress(o.addr),c=(0,D.Big)(this.fee).plus(f.MI.MIN_BALANCE),h=document.querySelector(".DaoSearch input"),p=a.checkUserPermission(e,"AddProposal","FunctionCall"),m=a.checkUserPermission(e,"VoteApprove","FunctionCall"),g={proposal:{description:`create multicall instance for this DAO at ${d}`,kind:{FunctionCall:{receiver_id:v.Multicall.FACTORY_ADDRESS,actions:[{method_name:"create",args:u.Base64.encode(JSON.stringify({multicall_init_args:{admin_accounts:[a.address],croncat_manager:window.nearConfig.CRONCAT_MANAGER_ADDRESS,job_bond:a.policy.proposal_bond},public_key:"HdJuXFRBKMEXuzEsXVscdd3aoBvEGGXDKQ3JoNhqJ4uU"})),deposit:c.toFixed(),gas:(0,D.toGas)("150")}]}}}};if(i.isBad()&&!r.isBad()&&!t&&this.lastAddr===h.value){if(-1===s)return p?(0,l.jsxs)(l.Fragment,{children:[(0,l.jsxs)("div",{className:"Alert",children:["A multicall instance can only be created for ",(0,l.jsx)("a",{href:a.getDaoUrl(x.SputnikUI.ASTRO_UI),target:"_blank",rel:"noopener noreferrer",children:a.address})," by making a proposal."]}),(0,l.jsx)("button",{className:"create-multicall",onClick:()=>{a.addProposal(g).then((e=>(0,j.signAndSendTxs)([e])))},children:"Propose"})]}):(0,l.jsx)("div",{className:"Alert",children:"This DAO has no multicall instance. A DAO member with proposing permissions should make a proposal."});if(-1!==s)return m?(null==n?void 0:n.votes[e])?(0,l.jsxs)("div",{className:"Alert",children:["You have voted on creating a multicall instance for this DAO. It will be created as soon as the proposal passes voting.",(0,l.jsx)("br",{}),(0,l.jsx)("a",{target:"_blank",href:a.getProposalUrl(x.SputnikUI.ASTRO_UI,s),rel:"noopener noreferrer",children:"Proposal on Astro"})]}):(0,l.jsxs)(l.Fragment,{children:[(0,l.jsxs)("div",{className:"Alert",children:[`There exists a proposal (#${s}) to create a multicall instance for this DAO. `,(0,l.jsx)("a",{href:a.getProposalUrl(x.SputnikUI.ASTRO_UI,s),target:"_blank",rel:"noopener noreferrer",children:"Open on AstroDAO"})]}),(0,l.jsx)("button",{className:"create-multicall proposal-exists",onClick:()=>{a.actProposal(s,"VoteApprove").then((e=>(0,j.signAndSendTxs)([e])))},children:"vote YES"})]}):(0,l.jsxs)("div",{className:"Alert",children:[`Proposal to create a multicall exists (#${s}), but you have no voting permissions on this DAO.`,(0,l.jsx)("br",{}),(0,l.jsx)("a",{target:"_blank",href:a.getProposalUrl(x.SputnikUI.ASTRO_UI,s),rel:"noopener noreferrer",children:"Proposal on Astro"})]})}}toLink(e,t=!0){return(0,l.jsxs)("span",{children:[(0,l.jsx)("a",{href:g.args.string().address().intoUrl().cast(e),target:"_blank",rel:"noopener noreferrer",children:e}),t?(0,l.jsx)(i.default,{}):null]})}job(e){return(0,l.jsxs)("div",{className:"JobsList-item",children:[(0,l.jsx)(r.default,{}),(0,l.jsx)(i.default,{}),e.is_active?(0,l.jsx)(d.default,{}):(0,l.jsx)(c.default,{}),(0,l.jsx)("pre",{children:JSON.stringify(e,null,"  ")})]})}tryLoadInfo(){this.lastAddr!==this.state.formData.addr&&(this.lastAddr=this.state.formData.addr,this.schema.check(this.state.formData).then((()=>{const{noDao:e}=(0,b.fields)(this.schema,"addr");this.schema.isBad()?e.isBad()?this.setState({proposed:-1,proposedInfo:null,dao:new(0,x.SputnikDAO)(this.state.formData.addr)}):this.confidentlyLoadOnlyDaoInfo():this.confidentlyLoadInfo()})))}confidentlyLoadOnlyDaoInfo(){const{addr:e}=this.state.formData,t=this.toMulticallAddress(e);this.setState({loading:!0}),x.SputnikDAO.init(e).catch((t=>new(0,x.SputnikDAO)(e))).then((e=>{var a,s;e.ready?this.proposalAlreadyExists(e).catch((e=>{})).then((n=>this.setState({dao:e,multicall:new(0,v.Multicall)(t),loading:!1,proposed:null!==(a=null==n?void 0:n.proposal_id)&&void 0!==a?a:-1,proposedInfo:null!==(s=null==n?void 0:n.proposal_info)&&void 0!==s?s:null}))):this.setState({dao:e,multicall:new(0,v.Multicall)(t),loading:!1})}))}confidentlyLoadInfo(){const{addr:e}=this.state.formData,t=this.toMulticallAddress(e);this.setState({loading:!0}),Promise.all([x.SputnikDAO.init(e).catch((t=>new(0,x.SputnikDAO)(e))),v.Multicall.init(t).catch((e=>new(0,v.Multicall)(t)))]).then((([e,t])=>{var a,s;e.ready&&t.ready?this.proposalAlreadyExists(e).catch((e=>{})).then((n=>this.setState({dao:e,multicall:t,loading:!1,proposed:null!==(a=null==n?void 0:n.proposal_id)&&void 0!==a?a:-1,proposedInfo:null!==(s=null==n?void 0:n.proposal_info)&&void 0!==s?s:null}))):this.setState({dao:e,multicall:t,loading:!1})}))}getContent(){const{selector:e}=this.context,{dao:t,loading:a,multicall:s}=this.state;if(!e.isSignedIn())return(0,l.jsx)("div",{className:"DaoPage-content error",children:"Please sign in to continue"});const n=["noAddress","noDao","noMulticall"],o=Object.entries((0,b.fields)(this.schema,"addr")).filter((([e,t])=>t.isBad()&&n.includes(e))).map((([e,t])=>(0,l.jsxs)("p",{className:"red",children:[(0,l.jsxs)("span",{children:[t.isBad()?"✗":"✔"," "]}),t.message()]},`p-${e}`)));return o.length>0?(0,l.jsx)(l.Fragment,{children:(0,l.jsxs)("div",{className:"DaoPage-content error",children:[(0,l.jsx)("div",{children:o}),this.createMulticall()]})}):a?(0,l.jsx)("div",{className:"DaoPage-content loader"}):s.admins&&s.tokensWhitelist&&s.jobBond?(0,l.jsx)(S.Tabs,{classes:{root:"DaoPage-tabs",buttonsPanel:"DaoPage-tabs-buttonsPanel",contentSpace:"DaoPage-tabs-contentSpace"},items:[y.DaoSettingsTab.uiConnect({className:`${k}-content`,adapters:{dao:t,multicall:s}}),N.DaoFundsTab.uiConnect({className:`${k}-content`,adapters:{dao:t,multicall:s}}),_.DaoJobsTab.uiConnect({className:`${k}-content`,multicallInstance:s})]}):(console.error("multicall infos incomplete",s),(0,l.jsx)("div",{className:"DaoPage-content error",children:"Unexpected error! Multicall might be outdated."}))}componentDidMount(){window.SIDEBAR.switchPage("dao"),document.addEventListener("onaddressesupdated",(e=>this.onAddressesUpdated(e)))}render(){var e;return(0,l.jsxs)("div",{className:"DaoPage",children:[(0,l.jsx)("div",{className:"DaoPage-header",children:(0,l.jsx)("div",{className:"DaoSearch",children:(0,l.jsx)(m.Formik,{initialValues:{addr:null!==(e=A.STORAGE.addresses.dao)&&void 0!==e?e:""},validate:e=>{this.setFormData({addr:e.addr}),this.tryLoadInfoDebounced()},onSubmit:()=>{},children:({setValues:e})=>(this.formikSetValues=e,(0,l.jsx)(m.Form,{children:(0,l.jsx)(O.TextField,{name:"addr",placeholder:"Search for DAOs",hiddenLabel:!0,variant:"standard",autoFocus:!0})}))})})}),this.getContent()]})}constructor(e){super(e),(0,o.default)(this,"schema",g.args.object().shape({addr:g.args.object().shape({noAddress:g.args.string().address().retain({initial:!0}),noDao:g.args.string().sputnikDao().retain({initial:!0}),noMulticall:g.args.string().multicall().retain({customMessage:"DAO does not have a multicall instance",initial:!0})}).transform(((e,t)=>({noAddress:t,noDao:t,noMulticall:this.toMulticallAddress(t)}))).retain()}).retain()),(0,o.default)(this,"tryLoadInfoDebounced",t(h)((()=>this.tryLoadInfo()),400)),(0,o.default)(this,"fee","");const a=A.STORAGE.addresses.dao;this.state={formData:{addr:a},dao:new(0,x.SputnikDAO)(a),multicall:new(0,v.Multicall)(this.toMulticallAddress(a)),loading:!1,proposed:-1,proposedInfo:null},this.schema.check(this.state.formData),v.Multicall.getFactoryFee().then((e=>{this.fee=e,this.tryLoadInfo()})),this.lastAddr=null}}(0,o.default)(M,"contextType",P)})),a.register("66p6C",(function(t,s){e(t.exports,"default",(function(){return l}));var n=a("6PKLM"),o=a("bbzbN"),l=(0,n.default)((0,o.jsx)("path",{d:"M6 19h4V5H6v14zm8-14v14h4V5h-4z"}),"PauseOutlined")})),a.register("hRwrB",(function(t,s){e(t.exports,"default",(function(){return l}));var n=a("6PKLM"),o=a("bbzbN"),l=(0,n.default)((0,o.jsx)("path",{d:"M10 8.64 15.27 12 10 15.36V8.64M8 5v14l11-7L8 5z"}),"PlayArrowOutlined")})),a.register("j7gVq",(function(t,s){e(t.exports,"DaoSettingsTab",(function(){return r}));var n=a("bbzbN"),o=a("jtRae"),l=a("4ys6O");const i=({className:e,adapters:t,...a})=>(0,n.jsx)("div",{className:(0,o.default)("DaoSettingsTab",e),...a,children:(0,n.jsx)(l.SettingsEditor.UI,{adapters:t})}),r={uiConnect:e=>({content:(0,n.jsx)(i,{...e}),name:"Settings"})}})),a.register("cZYma",(function(t,s){e(t.exports,"DaoFundsTab",(function(){return r}));var n=a("bbzbN"),o=a("jtRae"),l=a("4ys6O");const i=({className:e,adapters:t,...a})=>(0,n.jsx)("div",{className:(0,o.default)("DaoFundsTab",e),...a,children:(0,n.jsx)(l.TokenBalances.UI,{adapters:t})}),r={uiConnect:e=>({content:(0,n.jsx)(i,{...e}),lazy:!0,name:"Funds"})}})),a.register("4QTOn",(function(t,s){e(t.exports,"DaoJobsTab",(function(){return r}));var n=a("bbzbN"),o=a("jtRae"),l=a("gHnkO");const i=({className:e,multicallInstance:t,...a})=>(0,n.jsx)("div",{className:(0,o.default)("DaoJobsTab",e),...a,children:(0,n.jsx)(l.Job.EntriesTable,{multicallInstance:t})}),r={uiConnect:e=>({content:(0,n.jsx)(i,{...e}),lazy:!0,name:"Jobs"})}}));
//# sourceMappingURL=dao.5543b177.js.map
